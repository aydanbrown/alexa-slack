var slack = require('slack')('xoxp-89670216483-89737576834-89670820275-f424ea0798674acb6f0b33f96f1760d5');
var similar = require('string-similarity');

exports.help = function(intent, session, next) {
  var speechOutput = 'With Slack, you can select a channel by saying "select", then the channel name. ' +
  'To send a message just say "say", then the message you want to send. ' +
  'To get the last message, say read the last message. ' +
  'To get todays messages, say read todays messages. ' +
  'Have fun slacking!';

  next(session.attributes, buildSpeechletResponse('Slack Help', speechOutput, '', false));
}

exports.selectChannel = function(intent, session, next) {
  console.log('selectChannel');
  var channelSlot = intent.slots.Channel;
  var sessionAttributes = session.attributes;
  var outputSpeech = '';

  slack('channels.list', {}, function(err, res) {
    if(err) {
      console.error(err);

    } else if(!res.ok) {
      console.log();
    } else {
      var tests = {};
      var comparison = [];
      res.channels.forEach(function(channel) {
        tests[channel.name] = channel.id;
        comparison.push(channel.name);
      });
      var matches = similar.findBestMatch(channelSlot, comparison);
      console.log('Channel matches: ' + matches);
      console.log('Matching Channel: ' + tests[matches.bestMatch.target] + ', ' + matches.bestMatch.rating);
    }
  });
}

exports.sendMessageChannel = function(intent, session, next) {

}

exports.readMessageChannel = function(intent, session, next) {

}

exports.listMessagesChannel = function(intent, session, next) {

}

function buildSpeechletResponse(title, output, repromptText, shouldEndSession) {
  return {
    outputSpeech: {
      type: "PlainText",
      text: output
    },
    card: {
      type: "Simple",
      title: "SessionSpeechlet - " + title,
      content: "SessionSpeechlet - " + output
    },
    reprompt: {
      outputSpeech: {
        type: "PlainText",
        text: repromptText
      }
    },
    shouldEndSession: shouldEndSession
  };
}
